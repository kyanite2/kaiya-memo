<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“’ ã‚«ã‚¤ãƒ¤ãƒ¡ãƒ¢å¸³ï¼ˆPWAï¼‰</title>
<meta name="theme-color" content="#4CAF50" />

<!-- PWAè¨­å®š -->
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ã‚«ã‚¤ãƒ¤ãƒ¡ãƒ¢">

<style>
  :root { --bg:#f7f4ee; --card:#ffffff; --ink:#222; --muted:#777; --green:#4CAF50; --danger:#e74c3c; --star:#f0b400; }
  html,body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", "Noto Sans JP", sans-serif; }
  .wrap { max-width:860px; margin:0 auto; padding:18px 14px 80px; }
  h1 { margin:0 0 6px; font-size:1.6rem; font-weight:800; letter-spacing:.02em; }
  .status { font-size:.9rem; color:var(--muted); margin-bottom:10px; }
  .row { margin:8px 0; }
  input, textarea { width:100%; box-sizing:border-box; padding:.8rem .9rem; border:2px solid #d9d9d9; border-radius:12px; background:#fff; font-size:1rem; }
  textarea { min-height:140px; resize:vertical; }
  .btn { display:inline-flex; align-items:center; gap:.4rem; padding:.7rem 1.1rem; border-radius:12px; border:none; cursor:pointer; font-size:1rem; transition: all 0.2s ease; }
  .btn:hover { transform: translateY(-1px); }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-primary { background:var(--green); color:#fff; }
  .btn-ghost { background:transparent; border:2px solid #ddd; }
  .btn-danger { background:transparent; color:var(--danger); border:2px solid var(--danger); }
  .notes { margin-top:20px; display:flex; flex-direction:column; gap:10px; }
  .note { background:var(--card); border-radius:14px; border:1px solid #e8e5de; padding:10px 12px; position:relative; box-shadow: 0 2px 4px rgba(0,0,0,.04); transition: transform 0.2s ease; }
  .note:hover { transform: translateY(-2px); }
  .note.dragging { opacity: 0.5; transform: rotate(5deg); z-index: 1000; }
  .note.drag-over { border-color: var(--green); background: #f0fff0; }
  .drag-handle { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #ccc; cursor: grab; font-size: 18px; user-select: none; opacity: 0; transition: opacity 0.2s ease; }
  .note:hover .drag-handle { opacity: 1; }
  .drag-handle:active { cursor: grabbing; }
  .note-head { display:flex; align-items:center; gap:10px; }
  .note-title { flex:1; font-weight:700; padding:.6rem .7rem; border-radius:10px; background:#f4f4f4; }
  .note-body { margin:.5rem .1rem 0; padding:.6rem .2rem; border-top:1px solid #eee; white-space:pre-wrap; word-break:break-word; color:#333; display: none; transition: all 0.3s ease; }
  .note-body.open { display: block; }
  .note-title { flex:1; font-weight:700; padding:.6rem .7rem; border-radius:10px; background:#f4f4f4; cursor: pointer; user-select: none; transition: background-color 0.2s ease; -webkit-tap-highlight-color: transparent; }
  .note-title:hover { background: #e8e8e8; }
  .note-title:active { background: #ddd; }
  .close-btn { position: fixed; top: 20px; right: 20px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; font-size: 18px; line-height: 1; display: none; align-items: center; justify-content: center; opacity: 0.9; transition: all 0.2s ease; z-index: 1000; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); }
  .close-btn:hover { opacity: 1; transform: scale(1.1); box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4); }
  .close-btn.show { display: flex; }
  .note-foot { display:flex; gap:8px; justify-content:flex-end; padding-top:.5rem; }
  .pin { font-size:1.2rem; color:#bbb; cursor:pointer; user-select:none; }
  .pin.active { color:var(--star); filter: drop-shadow(0 1px 0 rgba(0,0,0,.1)); }
  .muted { color:var(--muted); font-size:.85rem; }
  .search { position:relative; }
  .search input { padding-left:2.2rem; }
  .search::before { content:"ğŸ”"; position:absolute; left:.6rem; top:.55rem; opacity:.55; }
  .toolbar { display:flex; gap:8px; align-items:center; margin:.4rem 0 1rem; }
  .badge { background:#eef6ff; border:1px solid #cde3ff; color:#357; padding:.2rem .5rem; border-radius:999px; font-size:.78rem; }
  .star-btn { background:transparent; border:none; cursor:pointer; font-size:1.4rem; line-height:1; transition: transform 0.2s ease; }
  .star-btn:hover { transform: scale(1.1); }
  .loading { display: none; }
  .loading.show { display: inline-block; }
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 480px) {
    .wrap { padding: 12px 10px 60px; }
    .note-foot { flex-direction: column; gap: 6px; }
    .btn { padding: .6rem .8rem; font-size: .9rem; }
    .drag-handle { display: none; } /* ãƒ¢ãƒã‚¤ãƒ«ã§ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’éè¡¨ç¤º */
    .note-head, .note-body, .note-foot { margin-left: 0 !important; } /* ãƒ¢ãƒã‚¤ãƒ«ã§ãƒãƒ¼ã‚¸ãƒ³ãƒªã‚»ãƒƒãƒˆ */
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“’ ã‚«ã‚¤ãƒ¤ãƒ¡ãƒ¢å¸³ï¼ˆPWAï¼‰</h1>
  <div id="status" class="status">æ¥ç¶šçŠ¶æ…‹: åˆ¤å®šä¸­â€¦</div>

  <div class="row search">
    <input id="search" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„æœ¬æ–‡ã§æ¤œç´¢" autocomplete="off" />
  </div>
  <div class="row">
    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
  </div>
  <div class="row">
    <textarea id="content" placeholder="ãƒ¡ãƒ¢å†…å®¹ï¼ˆæ”¹è¡ŒOKï¼‰"></textarea>
  </div>
  <div class="row">
    <button id="save" class="btn btn-primary">
      <span class="loading" id="saveLoading">ğŸ’­</span>
      <span id="saveText">ğŸ’¾ æ–°è¦ä¿å­˜</span>
    </button>
    <button id="cancel" class="btn btn-ghost" style="display:none;">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <div id="notes" class="notes"></div>

  <!-- å›ºå®šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="fixedCloseBtn" class="close-btn">Ã—</button>
</div>

<script type="module">
// ======= Service Worker ç™»éŒ² =======
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const registration = await navigator.serviceWorker.register('./sw.js');
      console.log('SW registered: ', registration);
    } catch (error) {
      console.log('SW registration failed: ', error);
    }
  });
}

// ======= Firebase SDK =======
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import {
  getFirestore, enableIndexedDbPersistence,
  collection, addDoc, doc, updateDoc, setDoc, deleteDoc,
  onSnapshot, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// === Firebaseè¨­å®š ===
const firebaseConfig = {
  apiKey: "AIzaSyDk9wJ0tEMn47X6z1kfdia4a-e0-Mt5vAA",
  authDomain: "kyanitememo-book.firebaseapp.com",
  projectId: "kyanitememo-book",
  storageBucket: "kyanitememo-book.appspot.com",
  messagingSenderId: "574061254095",
  appId: "1:574061254095:web:3fe06ec6843e1b284053ba"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰
try { 
  await enableIndexedDbPersistence(db); 
  console.log('Offline persistence enabled');
} catch(e){ 
  console.log('Offline persistence failed:', e.message); 
}

// ======= UI refs =======
const statusEl  = document.getElementById('status');
const titleEl   = document.getElementById('title');
const contentEl = document.getElementById('content');
const saveBtn   = document.getElementById('save');
const saveLoadingEl = document.getElementById('saveLoading');
const saveTextEl = document.getElementById('saveText');
const cancelBtn = document.getElementById('cancel');
const notesEl   = document.getElementById('notes');
const searchEl  = document.getElementById('search');
const fixedCloseBtn = document.getElementById('fixedCloseBtn');

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
const VERSION = "v-2025-08-23-pwa-fix";
function updateNetStatus(){ 
  const online = navigator.onLine;
  statusEl.textContent = `æ¥ç¶šçŠ¶æ…‹: ${online ? "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³"} / HTML: ${VERSION}`;
  statusEl.style.color = online ? "var(--green)" : "var(--danger)";
}
window.addEventListener('online', updateNetStatus);
window.addEventListener('offline', updateNetStatus);
updateNetStatus();

// ======= çŠ¶æ…‹ =======
let editingId = null;    // ç·¨é›†å¯¾è±¡ã® doc.id
let allNotes = [];       // è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã«ä½¿ã†ï¼‰
let isLoading = false;   // ä¿å­˜ä¸­ãƒ•ãƒ©ã‚°
let openNoteId = null;   // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒ¡ãƒ¢ã®ID
let draggedNote = null;  // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ¡ãƒ¢

// ======= ã‚¯ã‚¨ãƒªè³¼èª­ï¼ˆãƒ”ãƒ³â†’orderï¼‰ =======
const qNotes = query(
  collection(db, "notes"),
  orderBy("pinned", "desc"),
  orderBy("order",  "asc")
);

onSnapshot(qNotes, (snap) => {
  allNotes = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  render(allNotes, searchEl.value.trim());
  console.log(`Loaded ${allNotes.length} notes`);
}, (err)=>{
  statusEl.textContent = `â—Firestoreè³¼èª­ã‚¨ãƒ©ãƒ¼: ${err.message}`;
  statusEl.style.color = "var(--danger)";
  console.error('Firestore error:', err);
});

// ======= ä¿å­˜/æ›´æ–° =======
saveBtn.addEventListener('click', async () => {
  if (isLoading) return;
  
  const title = titleEl.value.trim();
  const content = contentEl.value.trim();
  if (!title && !content) {
    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  isLoading = true;
  saveLoadingEl.classList.add('show');
  saveBtn.disabled = true;

  try {
    if (!editingId) {
      // æ–°è¦ï¼šä¸¦ã³é †ã«å¿…é ˆã®2ã¤ã‚’å¿…ãšä»˜ä¸ï¼ˆæ–°ã—ã„ã‚‚ã®ã‚’ä¸Šã«è¡¨ç¤ºã™ã‚‹ãŸã‚å°ã•ã„å€¤ã‚’ä½¿ç”¨ï¼‰
      await addDoc(collection(db,"notes"), {
        title, content,
        pinned: false,
        order: -Date.now(), // è² ã®å€¤ã§æ–°ã—ã„ã‚‚ã®ãŒä¸Šã«æ¥ã‚‹
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
      console.log('New note created');
    } else {
      // æ—¢å­˜æ›´æ–°ï¼špinned/order ã‚’å£Šã•ãªã„ï¼
      const ref = doc(db, "notes", editingId);
      await updateDoc(ref, {
        title, content,
        updatedAt: serverTimestamp(),
      });
      console.log('Note updated:', editingId);
      exitEditMode();
    }
    // æˆåŠŸå¾Œã«ã ã‘ã‚¯ãƒªã‚¢
    clearForm();
  } catch (e) {
    alert("ä¿å­˜/æ›´æ–°ã«å¤±æ•—: " + e.message);
    console.error('Save error:', e);
  } finally {
    isLoading = false;
    saveLoadingEl.classList.remove('show');
    saveBtn.disabled = false;
  }
});

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
cancelBtn.addEventListener('click', () => {
  exitEditMode();
  clearForm();
});

// å›ºå®šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
fixedCloseBtn.addEventListener('click', () => {
  openNoteId = null;
  fixedCloseBtn.classList.remove('show');
  render(allNotes, searchEl.value.trim());
});

function exitEditMode() {
  editingId = null;
  saveTextEl.textContent = "ğŸ’¾ æ–°è¦ä¿å­˜";
  cancelBtn.style.display = "none";
}

function clearForm() {
  titleEl.value = "";
  contentEl.value = "";
}

// ======= ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =======
function render(list, keyword="") {
  const kw = keyword.toLowerCase();
  const filtered = kw
    ? list.filter(n =>
        (n.title||"").toLowerCase().includes(kw) ||
        (n.content||"").toLowerCase().includes(kw))
    : list;

  notesEl.innerHTML = "";

  // å›ºå®šé–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
  if (openNoteId) {
    fixedCloseBtn.classList.add('show');
  } else {
    fixedCloseBtn.classList.remove('show');
  }

  if (filtered.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.style.marginTop = '10px';
    empty.textContent = kw ? "è©²å½“ã™ã‚‹ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" : "ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
    notesEl.appendChild(empty);
    return;
  }

  for (const note of filtered) {
    const card = document.createElement('div');
    card.className = 'note';
    card.dataset.noteId = note.id;

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«
    const dragHandle = document.createElement('div');
    dragHandle.className = 'drag-handle';
    dragHandle.innerHTML = 'â‹®â‹®';
    dragHandle.title = 'ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ';

    // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCãƒ»ãƒ¢ãƒã‚¤ãƒ«ä¸¡å¯¾å¿œï¼‰
    dragHandle.addEventListener('mousedown', (e) => {
      card.draggable = true;
    });

    dragHandle.addEventListener('touchstart', (e) => {
      card.draggable = true;
      e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
    }, { passive: false });

    dragHandle.addEventListener('dragstart', (e) => {
      draggedNote = note;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', note.id);
    });

    // ã‚¿ãƒƒãƒç”¨ã®ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
    let touchStartY = 0;
    let touchCurrentY = 0;
    let isDragging = false;

    dragHandle.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
      isDragging = false;
    }, { passive: false });

    dragHandle.addEventListener('touchmove', (e) => {
      e.preventDefault();
      touchCurrentY = e.touches[0].clientY;
      
      if (Math.abs(touchCurrentY - touchStartY) > 10 && !isDragging) {
        isDragging = true;
        draggedNote = note;
        card.classList.add('dragging');
      }
      
      if (isDragging) {
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦–è¦šåŠ¹æœ
        card.style.transform = `translateY(${touchCurrentY - touchStartY}px)`;
        
        // ç¾åœ¨ã®ã‚¿ãƒƒãƒä½ç½®ã®ä¸‹ã«ã‚ã‚‹è¦ç´ ã‚’å–å¾—
        const elementBelow = document.elementFromPoint(e.touches[0].clientX, touchCurrentY);
        const noteBelow = elementBelow?.closest('.note');
        
        // ã™ã¹ã¦ã®drag-overã‚’å‰Šé™¤
        document.querySelectorAll('.drag-over').forEach(el => {
          el.classList.remove('drag-over');
        });
        
        if (noteBelow && noteBelow !== card) {
          noteBelow.classList.add('drag-over');
        }
      }
    }, { passive: false });

    dragHandle.addEventListener('touchend', (e) => {
      if (isDragging) {
        e.preventDefault();
        
        // ã‚¿ãƒƒãƒçµ‚äº†ä½ç½®ã®è¦ç´ ã‚’å–å¾—
        const elementBelow = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        const noteBelow = elementBelow?.closest('.note');
        
        if (noteBelow && noteBelow !== card && draggedNote) {
          const targetNoteId = noteBelow.dataset.noteId;
          const targetNote = allNotes.find(n => n.id === targetNoteId);
          if (targetNote) {
            reorderNotes(draggedNote.id, targetNote.id);
          }
        }
        
        // ãƒªã‚»ãƒƒãƒˆ
        card.style.transform = '';
        card.classList.remove('dragging');
        document.querySelectorAll('.drag-over').forEach(el => {
          el.classList.remove('drag-over');
        });
        draggedNote = null;
        isDragging = false;
      }
      card.draggable = false;
    }, { passive: false });

    // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
    card.addEventListener('dragstart', (e) => {
      // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰é–‹å§‹ã•ã‚ŒãŸå ´åˆã®ã¿è¨±å¯
      if (!card.draggable) {
        e.preventDefault();
        return false;
      }
      draggedNote = note;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', note.id);
    });

    card.addEventListener('dragend', (e) => {
      card.classList.remove('dragging');
      card.draggable = false; // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã¯ç„¡åŠ¹ã«ã™ã‚‹
      draggedNote = null;
      // ã™ã¹ã¦ã®drag-overã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
    });

    // ãƒã‚¦ã‚¹ãƒªãƒ¼ãƒ–æ™‚ã«ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹åŒ–
    card.addEventListener('mouseleave', (e) => {
      if (!e.buttons) { // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆ
        card.draggable = false;
      }
    });

    card.addEventListener('dragover', (e) => {
      if (draggedNote && draggedNote.id !== note.id) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        card.classList.add('drag-over');
      }
    });

    card.addEventListener('dragleave', (e) => {
      card.classList.remove('drag-over');
    });

    card.addEventListener('drop', async (e) => {
      e.preventDefault();
      card.classList.remove('drag-over');
      
      if (draggedNote && draggedNote.id !== note.id) {
        await reorderNotes(draggedNote.id, note.id);
      }
    });

    // header
    const head = document.createElement('div');
    head.className = 'note-head';
    
    // ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®šï¼ˆãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã¯å¸¸ã«è¡¨ç¤ºï¼‰
    const isMobile = window.innerWidth <= 480 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
      head.style.marginLeft = '48px'; // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
    } else {
      head.style.marginLeft = '24px'; // PCç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
    }

    const titleBox = document.createElement('div');
    titleBox.className = 'note-title';
    titleBox.textContent = note.title || "(ç„¡é¡Œ)";
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    titleBox.addEventListener('click', (e) => {
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢
      e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
      
      if (openNoteId === note.id) {
        openNoteId = null; // åŒã˜ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
      } else {
        openNoteId = note.id; // é•ã†ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‹ã
      }
      render(allNotes, searchEl.value.trim());
    });

    // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
    titleBox.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (openNoteId === note.id) {
        openNoteId = null;
      } else {
        openNoteId = note.id;
      }
      render(allNotes, searchEl.value.trim());
    });

    const pinBtn = document.createElement('button');
    pinBtn.className = 'star-btn';
    pinBtn.title = "ãƒ”ãƒ³ç•™ã‚";
    pinBtn.innerHTML = note.pinned ? "â­" : "â˜†";
    pinBtn.style.color = note.pinned ? "var(--star)" : "#999";
    pinBtn.addEventListener('click', async (e) => {
      e.stopPropagation(); // ã‚¿ã‚¤ãƒˆãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜»æ­¢
      try {
        await updateDoc(doc(db,"notes",note.id), { pinned: !note.pinned });
        console.log('Pin toggled:', note.id);
      } catch(e){ 
        alert("ãƒ”ãƒ³ç•™ã‚å¤±æ•—: "+e.message); 
        console.error('Pin error:', e);
      }
    });

    head.appendChild(titleBox);
    head.appendChild(pinBtn);

    // body
    const body = document.createElement('div');
    body.className = 'note-body';
    if (isMobile) {
      body.style.marginLeft = '48px'; // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
    } else {
      body.style.marginLeft = '24px'; // PCç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
    }
    if (openNoteId === note.id) {
      body.classList.add('open');
    }
    body.textContent = note.content || "";

    // foot - é–‹ã„ã¦ã„ã‚‹æ™‚ã®ã¿è¡¨ç¤º
    const foot = document.createElement('div');
    foot.className = 'note-foot';
    foot.style.display = openNoteId === note.id ? 'flex' : 'none';
    if (isMobile) {
      foot.style.marginLeft = '48px'; // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
    } else {
      foot.style.marginLeft = '24px'; // PCç”¨ã®ã‚¹ãƒšãƒ¼ã‚¹
    }

    const editBtn = document.createElement('button');
    editBtn.className = 'btn btn-ghost';
    editBtn.textContent = "âœï¸ ç·¨é›†";
    editBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      editingId = note.id;
      titleEl.value = note.title || "";
      contentEl.value = note.content || "";
      saveTextEl.textContent = "ğŸ“ æ›´æ–°";
      cancelBtn.style.display = "inline-flex";
      window.scrollTo({ top:0, behavior:'smooth' });
    });

    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-danger';
    delBtn.textContent = "ğŸ—‘ å‰Šé™¤";
    delBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm("ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try { 
        await deleteDoc(doc(db,"notes",note.id)); 
        console.log('Note deleted:', note.id);
        if (openNoteId === note.id) {
          openNoteId = null; // å‰Šé™¤ã—ãŸãƒ¡ãƒ¢ãŒé–‹ã„ã¦ã„ãŸå ´åˆã¯ã‚¯ãƒªã‚¢
        }
      }
      catch(e){ 
        alert("å‰Šé™¤ã«å¤±æ•—: "+e.message); 
        console.error('Delete error:', e);
      }
    });

    const time = document.createElement('div');
    time.className = 'muted';
    time.style.marginRight = "auto";
    
    // æ—¥æ™‚è¡¨ç¤ºã®æ”¹å–„
    if (note.createdAt?.toDate) {
      const date = note.createdAt.toDate();
      time.textContent = date.toLocaleString('ja-JP', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } else {
      time.textContent = "åŒæœŸä¸­...";
    }

    foot.appendChild(time);
    foot.appendChild(editBtn);
    foot.appendChild(delBtn);

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã¯PCãƒ»ãƒ¢ãƒã‚¤ãƒ«ä¸¡æ–¹ã§è¡¨ç¤º
    card.appendChild(dragHandle);
    card.appendChild(head);
    card.appendChild(body);
    card.appendChild(foot);
    card.draggable = false; // åˆæœŸçŠ¶æ…‹ã§ã¯ç„¡åŠ¹

    notesEl.appendChild(card);
  }
}

// ======= æ¤œç´¢ =======
let searchTimeout;
searchEl.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    render(allNotes, searchEl.value.trim());
  }, 300); // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
});

// ======= ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ =======
document.addEventListener('keydown', (e) => {
  // Ctrl+S ã¾ãŸã¯ Cmd+S ã§ä¿å­˜
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    if (!isLoading) {
      saveBtn.click();
    }
  }
  
  // Escapeã§ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  if (e.key === 'Escape' && editingId) {
    exitEditMode();
    clearForm();
  }
});

// ======= ä¸¦ã³æ›¿ãˆæ©Ÿèƒ½ =======
async function reorderNotes(draggedId, targetId) {
  try {
    const draggedNote = allNotes.find(n => n.id === draggedId);
    const targetNote = allNotes.find(n => n.id === targetId);
    
    if (!draggedNote || !targetNote) return;
    
    // ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒ¢åŒå£«ã€ã¾ãŸã¯é€šå¸¸ãƒ¡ãƒ¢åŒå£«ã®å ´åˆã®ã¿ä¸¦ã³æ›¿ãˆå¯èƒ½
    if (draggedNote.pinned !== targetNote.pinned) {
      alert('ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒ¢ã¨é€šå¸¸ãƒ¡ãƒ¢ã¯ä¸¦ã³æ›¿ãˆã§ãã¾ã›ã‚“');
      return;
    }
    
    // æ–°ã—ã„orderå€¤ã‚’è¨ˆç®—
    const targetIndex = allNotes.findIndex(n => n.id === targetId);
    let newOrder;
    
    if (targetIndex === 0) {
      // ä¸€ç•ªä¸Šã«ç§»å‹•
      newOrder = targetNote.order - 1;
    } else if (targetIndex === allNotes.length - 1) {
      // ä¸€ç•ªä¸‹ã«ç§»å‹•
      newOrder = targetNote.order + 1;
    } else {
      // é–“ã«æŒ¿å…¥
      const prevNote = allNotes[targetIndex - 1];
      newOrder = (prevNote.order + targetNote.order) / 2;
    }
    
    // Firestoreã‚’æ›´æ–°
    await updateDoc(doc(db, "notes", draggedId), {
      order: newOrder,
      updatedAt: serverTimestamp()
    });
    
    console.log('Note reordered:', draggedId, 'new order:', newOrder);
    
  } catch (error) {
    console.error('Reorder failed:', error);
    alert('ä¸¦ã³æ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

console.log('Kaiya Memo PWA initialized');
</script>
</body>
</html>
